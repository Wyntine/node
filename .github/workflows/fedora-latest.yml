name: Build & Publish Node.js RPM

on:
  push:
    branches:
      - main
      - 'release/*'
  workflow_dispatch:

jobs:
  build-nodejs-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4

      - name: Install RPM tooling & plugins
        run: |
          dnf group install -y c-development
          dnf install -y rpmdevtools dnf-plugins-core redhat-rpm-config ccache mold

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 5G

      - name: Build project
        run: |
          cd $GITHUB_WORKSPACE
          export CC="ccache gcc"
          export CXX="ccache g++"
          export LDFLAGS="-fuse-ld=mold"
          ./configure
          make -j$(nproc)

      - name: Add RPM spec
        run: |
          mkdir -p $HOME/rpmbuild/SPECS
          cat > $HOME/rpmbuild/SPECS/nodejs.spec <<'EOF'
          Name:           node
          Version:        25.0.0
          Release:        1%{?dist}
          Summary:        Custom Node.js runtime with ESM cache exposed

          License:        MIT
          URL:            https://github.com/Wyntine/node
          Source0:        node-%{version}.tar.gz

          %description
          Node.jsâ„¢ is a JavaScript runtime built on V8. This package is built from a custom fork.

          %prep
          %setup -q -c -T
          tar xzf %{_sourcedir}/node-%{version}.tar.gz

          %build
          ./configure --prefix=%{_prefix} --shared-openssl --shared-zlib
          make %{?_smp_mflags}

          %install
          rm -rf %{buildroot}
          make install DESTDIR=%{buildroot}

          %files
          %license LICENSE
          %{_bindir}/node
          %{_bindir}/npm
          %{_bindir}/npx
          %{_prefix}/lib/node_modules
          EOF

      - name: Install spec build dependencies
        run: |
          dnf builddep -y $HOME/rpmbuild/SPECS/nodejs.spec

      - name: Prepare the RPM build tree
        run: rpmdev-setuptree

      - name: Package built artifacts
        run: |
          cd $GITHUB_WORKSPACE
          TAR=node-25.0.0.tar.gz
          make install DESTDIR=$HOME/rpmbuild/BUILDROOT/nodejs
          tar czf $TAR -C $HOME/rpmbuild/BUILDROOT nodejs
          mv $TAR $HOME/rpmbuild/SOURCES/$TAR

      - name: Build the RPM
        run: rpmbuild -ba $HOME/rpmbuild/SPECS/nodejs.spec

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-rpm
          path: $HOME/rpmbuild/RPMS/**/*.rpm
