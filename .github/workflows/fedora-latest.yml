name: Fedora Latest
on:
  push:
    branches:
      - main
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install all build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 g++-12 gcc-12 make python3-pip \
            rpm build-essential \
            ccache mold

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 5G

      - name: Build project
        run: |
          cd $GITHUB_WORKSPACE
          export CC="ccache gcc"
          export CXX="ccache g++"
          export LDFLAGS="-fuse-ld=mold"
          ./configure
          make -j$(nproc)

      - name: Create RPM build environment
        run: |
          mkdir -p $HOME/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p $HOME/rpmbuild/BUILDROOT/nodejs
          echo "%_topdir $HOME/rpmbuild" > ~/.rpmmacros

      - name: Package built artifacts
        run: |
          cd $GITHUB_WORKSPACE
          TAR=node.tar.gz
          make install DESTDIR=$HOME/rpmbuild/BUILDROOT/nodejs
          tar czf $TAR -C $HOME/rpmbuild/BUILDROOT nodejs
          mv $TAR $HOME/rpmbuild/SOURCES/

      - name: Add RPM spec
        run: |
          cat > $HOME/rpmbuild/SPECS/nodejs.spec <<'EOF'
          Name:           nodejs
          Version:        25.0.0
          Release:        1%{?dist}
          Summary:        Custom Node.js runtime with ESM cache exposed

          License:        MIT
          URL:            https://github.com/Wyntine/node
          Source0:        node.tar.gz

          BuildRequires:  gcc, gcc-c++, make, python3, openssl-devel, zlib-devel, pkgconfig
          Requires:       libstdc++

          %description
          Node.jsâ„¢ is a JavaScript runtime built on V8. This package is built from a custom fork.

          %prep
          %setup -q -c -T
          tar xzf %{_sourcedir}/node.tar.gz

          %build
          cd node
          ./configure --prefix=%{_prefix} --shared-openssl --shared-zlib
          make %{?_smp_mflags}

          %install
          rm -rf %{buildroot}
          cd node
          make install DESTDIR=%{buildroot}

          %files
          %license LICENSE
          %{_bindir}/node
          %{_bindir}/npm
          %{_bindir}/npx
          %{_prefix}/lib/node_modules
          EOF

      - name: Build RPM
        run: rpmbuild -ba $HOME/rpmbuild/SPECS/nodejs.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-rpm
          path: $HOME/rpmbuild/RPMS/**/*.rpm
